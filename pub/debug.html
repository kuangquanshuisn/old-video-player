<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è°ƒè¯•è§†é¢‘æ’­æ”¾å™¨</title>
  <style>
    body {
      font-family: -apple-system, "Helvetica Neue", Arial, sans-serif;
      padding: 20px;
      background: #f0f0f0;
      margin: 0;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    h2 {
      color: #555;
      margin-top: 30px;
      margin-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 5px;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      border: 1px solid #dee2e6;
      font-size: 13px;
      line-height: 1.5;
      max-height: 400px;
      overflow-y: auto;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
      transition: background 0.2s;
    }
    button:hover {
      background: #0056b3;
    }
    button.danger {
      background: #dc3545;
    }
    button.danger:hover {
      background: #c82333;
    }
    button.success {
      background: #28a745;
    }
    button.success:hover {
      background: #218838;
    }
    .video-item {
      background: #f8f9fa;
      padding: 15px;
      margin: 8px 0;
      border-radius: 4px;
      border: 1px solid #dee2e6;
      cursor: pointer;
      transition: all 0.2s;
    }
    .video-item:hover {
      background: #e9ecef;
      border-color: #adb5bd;
    }
    .video-title {
      font-weight: bold;
      color: #333;
      font-size: 16px;
    }
    .episode-count {
      color: #666;
      font-size: 14px;
      margin-top: 5px;
    }
    .episode-list {
      display: none;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #dee2e6;
    }
    .episode-item {
      display: inline-block;
      padding: 5px 10px;
      margin: 3px;
      background: #e9ecef;
      border-radius: 3px;
      font-size: 12px;
      color: #495057;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .stat-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      border: 1px solid #dee2e6;
      text-align: center;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #007bff;
    }
    .stat-label {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
    .test-video {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 4px;
      border: 1px solid #dee2e6;
    }
    .test-video input {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
    }
    .timestamp {
      font-size: 12px;
      color: #999;
    }
    .console-log {
      background: #263238;
      color: #aed581;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
      margin: 10px 0;
    }
    .log-entry {
      margin: 2px 0;
      padding: 2px 0;
    }
    .log-error {
      color: #ff5252;
    }
    .log-warn {
      color: #ffd54f;
    }
    .log-info {
      color: #64b5f6;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ è§†é¢‘æ’­æ”¾å™¨è°ƒè¯•é¡µé¢</h1>
    
    <div id="status-container"></div>
    
    <h2>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h2>
    <div class="stats-grid" id="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="total-series">-</div>
        <div class="stat-label">è§†é¢‘ç³»åˆ—æ€»æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="total-episodes">-</div>
        <div class="stat-label">å‰§é›†æ€»æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="user-series">-</div>
        <div class="stat-label">ç”¨æˆ·æ·»åŠ ç³»åˆ—</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="history-count">-</div>
        <div class="stat-label">æ’­æ”¾å†å²è®°å½•</div>
      </div>
    </div>
    
    <h2>ğŸ¬ æ“ä½œæŒ‰é’®</h2>
    <div>
      <button onclick="checkDataJs()">æ£€æŸ¥ data.js æ–‡ä»¶</button>
      <button onclick="checkLocalStorage()">æ£€æŸ¥æœ¬åœ°å­˜å‚¨</button>
      <button onclick="testVideoPlayback()">æµ‹è¯•è§†é¢‘æ’­æ”¾</button>
      <button onclick="exportData()">å¯¼å‡ºæ‰€æœ‰æ•°æ®</button>
      <button onclick="checkVideoUrls()">æ£€æŸ¥è§†é¢‘é“¾æ¥</button>
      <button class="success" onclick="goToMainPage()">è¿”å›ä¸»é¡µé¢</button>
    </div>
    <div style="margin-top: 10px;">
      <button class="danger" onclick="clearAuth()">æ¸…é™¤è®¤è¯ä¿¡æ¯</button>
      <button class="danger" onclick="clearHistory()">æ¸…é™¤æ’­æ”¾å†å²</button>
      <button class="danger" onclick="clearUserVideos()">æ¸…é™¤ç”¨æˆ·è§†é¢‘</button>
      <button class="danger" onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
    </div>
    
    <h2>ğŸ¥ æµ‹è¯•è§†é¢‘æ’­æ”¾</h2>
    <div class="test-video">
      <input type="text" id="test-url" placeholder="è¾“å…¥è§†é¢‘URLè¿›è¡Œæµ‹è¯•" value="https://cdn.wlcdn88.com:777/20220420/xjPSLTlP/index.m3u8">
      <button onclick="playTestVideo()">æ’­æ”¾æµ‹è¯•</button>
      <div id="test-result"></div>
    </div>
    
    <h2>ğŸ“º è§†é¢‘æ•°æ®</h2>
    <div id="video-data"></div>
    
    <h2>ğŸ–¥ï¸ æ§åˆ¶å°æ—¥å¿—</h2>
    <div class="console-log" id="console-log">
      <div class="log-entry log-info">æ§åˆ¶å°æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
    </div>
    
    <h2>ğŸ” è°ƒè¯•ä¿¡æ¯</h2>
    <pre id="debug-info"></pre>
  </div>

  <script src="data.js"></script>
  <script>
    // æ•è·æ§åˆ¶å°è¾“å‡º
    (function() {
      const logContainer = document.getElementById('console-log');
      const originalLog = console.log;
      const originalError = console.error;
      const originalWarn = console.warn;
      
      function addLogEntry(message, type = 'info') {
        const entry = document.createElement('div');
        entry.className = `log-entry log-${type}`;
        const time = new Date().toLocaleTimeString();
        entry.textContent = `[${time}] ${message}`;
        logContainer.appendChild(entry);
        logContainer.scrollTop = logContainer.scrollHeight;
      }
      
      console.log = function(...args) {
        originalLog.apply(console, args);
        addLogEntry(args.join(' '), 'info');
      };
      
      console.error = function(...args) {
        originalError.apply(console, args);
        addLogEntry(args.join(' '), 'error');
      };
      
      console.warn = function(...args) {
        originalWarn.apply(console, args);
        addLogEntry(args.join(' '), 'warn');
      };
    })();

    function addStatus(message, type = 'info') {
      const container = document.getElementById('status-container');
      const div = document.createElement('div');
      div.className = `status ${type}`;
      const time = new Date().toLocaleTimeString();
      div.innerHTML = `<span>${message}</span><span class="timestamp">${time}</span>`;
      container.appendChild(div);
      
      // è‡ªåŠ¨æ¸…é™¤æ—§çš„çŠ¶æ€æ¶ˆæ¯
      if (container.children.length > 5) {
        container.removeChild(container.firstChild);
      }
    }

    function updateStats() {
      try {
        // ç»Ÿè®¡æ•°æ®
        let totalSeries = 0;
        let totalEpisodes = 0;
        let userSeries = 0;
        
        if (typeof playerData !== 'undefined') {
          totalSeries = playerData.length;
          totalEpisodes = playerData.reduce((sum, series) => sum + series.episodes.length, 0);
        }
        
        const userVideoData = localStorage.getItem('userVideoSeriesData');
        if (userVideoData) {
          const userData = JSON.parse(userVideoData);
          userSeries = userData.length;
          totalSeries += userData.length;
          totalEpisodes += userData.reduce((sum, series) => sum + series.episodes.length, 0);
        }
        
        const playHistory = localStorage.getItem('playHistory');
        const historyCount = playHistory ? JSON.parse(playHistory).length : 0;
        
        // æ›´æ–°æ˜¾ç¤º
        document.getElementById('total-series').textContent = totalSeries;
        document.getElementById('total-episodes').textContent = totalEpisodes;
        document.getElementById('user-series').textContent = userSeries;
        document.getElementById('history-count').textContent = historyCount;
        
      } catch (e) {
        console.error('æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', e);
      }
    }

    function checkDataJs() {
      const debugInfo = document.getElementById('debug-info');
      const videoData = document.getElementById('video-data');
      
      try {
        if (typeof playerData !== 'undefined') {
          addStatus(`æˆåŠŸåŠ è½½ data.jsï¼ŒåŒ…å« ${playerData.length} ä¸ªè§†é¢‘ç³»åˆ—`, 'success');
          console.log(`data.js åŠ è½½æˆåŠŸï¼ŒåŒ…å« ${playerData.length} ä¸ªè§†é¢‘ç³»åˆ—`);
          
          // æ˜¾ç¤ºè§†é¢‘æ•°æ®
          videoData.innerHTML = '';
          
          // åˆå¹¶æ‰€æœ‰æ•°æ®
          let allData = [...playerData];
          const userVideoData = localStorage.getItem('userVideoSeriesData');
          if (userVideoData) {
            const userData = JSON.parse(userVideoData);
            allData = allData.concat(userData);
          }
          
          allData.forEach((series, index) => {
            const div = document.createElement('div');
            div.className = 'video-item';
            const isUserAdded = index >= playerData.length;
            
            div.innerHTML = `
              <div class="video-title">
                ${index + 1}. ${series.title} 
                ${isUserAdded ? '<span style="color: #28a745;">[ç”¨æˆ·æ·»åŠ ]</span>' : '<span style="color: #007bff;">[ç³»ç»Ÿ]</span>'}
              </div>
              <div class="episode-count">å…± ${series.episodes.length} é›†</div>
              <div class="episode-list" id="episodes-${index}"></div>
            `;
            
            // ç‚¹å‡»å±•å¼€å‰§é›†åˆ—è¡¨
            div.onclick = function() {
              const episodeList = document.getElementById(`episodes-${index}`);
              if (episodeList.style.display === 'block') {
                episodeList.style.display = 'none';
              } else {
                episodeList.style.display = 'block';
                if (episodeList.innerHTML === '') {
                  series.episodes.forEach((ep, epIndex) => {
                    const epDiv = document.createElement('span');
                    epDiv.className = 'episode-item';
                    epDiv.textContent = ep.name;
                    epDiv.title = ep.url;
                    episodeList.appendChild(epDiv);
                  });
                }
              }
            };
            
            videoData.appendChild(div);
          });
          
          // æ˜¾ç¤ºè¯¦ç»†æ•°æ®
          debugInfo.textContent = JSON.stringify(allData, null, 2);
        } else {
          addStatus('é”™è¯¯ï¼šplayerData æœªå®šä¹‰ï¼Œdata.js å¯èƒ½æœªæ­£ç¡®åŠ è½½', 'error');
          console.error('playerData æœªå®šä¹‰');
          debugInfo.textContent = 'æ— æ³•æ‰¾åˆ° playerData å˜é‡';
        }
        
        updateStats();
      } catch (e) {
        addStatus(`é”™è¯¯ï¼š${e.message}`, 'error');
        console.error('æ£€æŸ¥ data.js å¤±è´¥:', e);
        debugInfo.textContent = e.stack;
      }
    }

    function checkLocalStorage() {
      const debugInfo = document.getElementById('debug-info');
      
      try {
        const authData = localStorage.getItem('videoPlayerAuth');
        const userVideoData = localStorage.getItem('userVideoSeriesData');
        const playHistory = localStorage.getItem('playHistory');
        const playbackProgress = localStorage.getItem('playbackProgress');
        
        const data = {
          è®¤è¯ä¿¡æ¯: authData ? JSON.parse(authData) : null,
          ç”¨æˆ·è§†é¢‘æ•°æ®: userVideoData ? JSON.parse(userVideoData) : null,
          æ’­æ”¾å†å²: playHistory ? JSON.parse(playHistory) : null,
          æ’­æ”¾è¿›åº¦: playbackProgress ? JSON.parse(playbackProgress) : null
        };
        
        debugInfo.textContent = JSON.stringify(data, null, 2);
        
        if (authData) {
          const auth = JSON.parse(authData);
          const now = Date.now();
          if (now > auth.expiry) {
            addStatus('è®¤è¯å·²è¿‡æœŸ', 'error');
          } else {
            const daysLeft = Math.round((auth.expiry - now) / (24 * 60 * 60 * 1000));
            addStatus(`è®¤è¯æœ‰æ•ˆï¼Œå‰©ä½™ ${daysLeft} å¤©`, 'success');
          }
        } else {
          addStatus('æœªæ‰¾åˆ°è®¤è¯ä¿¡æ¯', 'warning');
        }
        
        if (userVideoData) {
          const userData = JSON.parse(userVideoData);
          addStatus(`æ‰¾åˆ° ${userData.length} ä¸ªç”¨æˆ·æ·»åŠ çš„è§†é¢‘ç³»åˆ—`, 'info');
        }
        
        if (playHistory) {
          const history = JSON.parse(playHistory);
          addStatus(`æ‰¾åˆ° ${history.length} æ¡æ’­æ”¾å†å²è®°å½•`, 'info');
        }
        
        console.log('æœ¬åœ°å­˜å‚¨æ£€æŸ¥å®Œæˆ');
        updateStats();
        
      } catch (e) {
        addStatus(`é”™è¯¯ï¼š${e.message}`, 'error');
        console.error('æ£€æŸ¥æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
        debugInfo.textContent = e.stack;
      }
    }

    function testVideoPlayback() {
      addStatus('å¼€å§‹æµ‹è¯•è§†é¢‘æ’­æ”¾åŠŸèƒ½...', 'info');
      console.log('æµ‹è¯•è§†é¢‘æ’­æ”¾åŠŸèƒ½');
      
      // åˆ›å»ºæµ‹è¯•æ’­æ”¾å™¨
      const testContainer = document.getElementById('test-result');
      testContainer.innerHTML = `
        <video id="test-player" controls style="width: 100%; max-width: 600px; margin-top: 10px;">
          <source src="" type="application/x-mpegURL">
        </video>
      `;
      
      // æµ‹è¯•ç¬¬ä¸€ä¸ªè§†é¢‘
      if (typeof playerData !== 'undefined' && playerData.length > 0 && playerData[0].episodes.length > 0) {
        const testUrl = playerData[0].episodes[0].url;
        const video = document.getElementById('test-player');
        video.src = testUrl;
        
        video.onloadedmetadata = function() {
          addStatus('è§†é¢‘å…ƒæ•°æ®åŠ è½½æˆåŠŸ', 'success');
          console.log('è§†é¢‘å…ƒæ•°æ®åŠ è½½æˆåŠŸ');
        };
        
        video.onerror = function() {
          addStatus('è§†é¢‘åŠ è½½å¤±è´¥', 'error');
          console.error('è§†é¢‘åŠ è½½å¤±è´¥');
        };
        
        addStatus(`æ­£åœ¨æµ‹è¯•æ’­æ”¾: ${playerData[0].title} - ${playerData[0].episodes[0].name}`, 'info');
      } else {
        addStatus('æ²¡æœ‰å¯ç”¨çš„è§†é¢‘è¿›è¡Œæµ‹è¯•', 'warning');
      }
    }

    function playTestVideo() {
      const url = document.getElementById('test-url').value;
      if (!url) {
        addStatus('è¯·è¾“å…¥è§†é¢‘URL', 'warning');
        return;
      }
      
      const testContainer = document.getElementById('test-result');
      testContainer.innerHTML = `
        <video id="test-player" controls style="width: 100%; max-width: 600px; margin-top: 10px;">
          <source src="${url}" type="application/x-mpegURL">
        </video>
      `;
      
      const video = document.getElementById('test-player');
      
      video.onloadedmetadata = function() {
        addStatus('æµ‹è¯•è§†é¢‘åŠ è½½æˆåŠŸ', 'success');
        console.log('æµ‹è¯•è§†é¢‘åŠ è½½æˆåŠŸ:', url);
      };
      
      video.onerror = function() {
        addStatus('æµ‹è¯•è§†é¢‘åŠ è½½å¤±è´¥', 'error');
        console.error('æµ‹è¯•è§†é¢‘åŠ è½½å¤±è´¥:', url);
      };
      
      video.play().catch(function(e) {
        console.error('æ’­æ”¾å¤±è´¥:', e);
      });
    }

    function exportData() {
      try {
        const exportData = {
          playerData: typeof playerData !== 'undefined' ? playerData : [],
          userVideoData: localStorage.getItem('userVideoSeriesData') ? JSON.parse(localStorage.getItem('userVideoSeriesData')) : [],
          playHistory: localStorage.getItem('playHistory') ? JSON.parse(localStorage.getItem('playHistory')) : [],
          playbackProgress: localStorage.getItem('playbackProgress') ? JSON.parse(localStorage.getItem('playbackProgress')) : null,
          exportTime: new Date().toISOString()
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `video-player-data-${new Date().getTime()}.json`;
        link.click();
        
        addStatus('æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
        console.log('æ•°æ®å¯¼å‡ºæˆåŠŸ');
      } catch (e) {
        addStatus(`å¯¼å‡ºå¤±è´¥: ${e.message}`, 'error');
        console.error('å¯¼å‡ºå¤±è´¥:', e);
      }
    }

    function checkVideoUrls() {
      addStatus('å¼€å§‹æ£€æŸ¥è§†é¢‘é“¾æ¥...', 'info');
      console.log('å¼€å§‹æ£€æŸ¥è§†é¢‘é“¾æ¥');
      
      let allData = [];
      if (typeof playerData !== 'undefined') {
        allData = [...playerData];
      }
      
      const userVideoData = localStorage.getItem('userVideoSeriesData');
      if (userVideoData) {
        allData = allData.concat(JSON.parse(userVideoData));
      }
      
      let totalVideos = 0;
      let checkedVideos = 0;
      let failedVideos = [];
      
      allData.forEach((series, seriesIndex) => {
        series.episodes.forEach((episode, episodeIndex) => {
          totalVideos++;
          
          // ä½¿ç”¨ fetch æ£€æŸ¥ URL æ˜¯å¦å¯è®¿é—®
          fetch(episode.url, { method: 'HEAD', mode: 'no-cors' })
            .then(() => {
              checkedVideos++;
              console.log(`âœ“ ${series.title} - ${episode.name}`);
              
              if (checkedVideos === totalVideos) {
                addStatus(`æ£€æŸ¥å®Œæˆ: ${totalVideos - failedVideos.length}/${totalVideos} ä¸ªè§†é¢‘é“¾æ¥æœ‰æ•ˆ`, 
                  failedVideos.length > 0 ? 'warning' : 'success');
                
                if (failedVideos.length > 0) {
                  console.error('å¤±è´¥çš„è§†é¢‘:', failedVideos);
                }
              }
            })
            .catch((error) => {
              checkedVideos++;
              failedVideos.push({
                series: series.title,
                episode: episode.name,
                url: episode.url,
                error: error.message
              });
              console.error(`âœ— ${series.title} - ${episode.name}:`, error.message);
              
              if (checkedVideos === totalVideos) {
                addStatus(`æ£€æŸ¥å®Œæˆ: ${totalVideos - failedVideos.length}/${totalVideos} ä¸ªè§†é¢‘é“¾æ¥æœ‰æ•ˆ`, 
                  failedVideos.length > 0 ? 'warning' : 'success');
                
                if (failedVideos.length > 0) {
                  console.error('å¤±è´¥çš„è§†é¢‘:', failedVideos);
                }
              }
            });
        });
      });
      
      if (totalVideos === 0) {
        addStatus('æ²¡æœ‰è§†é¢‘éœ€è¦æ£€æŸ¥', 'warning');
      }
    }

    function clearAuth() {
      if (confirm('ç¡®å®šè¦æ¸…é™¤è®¤è¯ä¿¡æ¯å—ï¼Ÿä¸‹æ¬¡è®¿é—®éœ€è¦é‡æ–°è¾“å…¥å¯†ç ã€‚')) {
        localStorage.removeItem('videoPlayerAuth');
        addStatus('è®¤è¯ä¿¡æ¯å·²æ¸…é™¤', 'success');
        updateStats();
      }
    }

    function clearHistory() {
      if (confirm('ç¡®å®šè¦æ¸…é™¤æ’­æ”¾å†å²å—ï¼Ÿ')) {
        localStorage.removeItem('playHistory');
        localStorage.removeItem('playbackProgress');
        addStatus('æ’­æ”¾å†å²å·²æ¸…é™¤', 'success');
        updateStats();
      }
    }

    function clearUserVideos() {
      if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç”¨æˆ·æ·»åŠ çš„è§†é¢‘å—ï¼Ÿ')) {
        localStorage.removeItem('userVideoSeriesData');
        addStatus('ç”¨æˆ·è§†é¢‘å·²æ¸…é™¤', 'success');
        updateStats();
        checkDataJs();
      }
    }

    function clearAllData() {
      if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ç”¨æˆ·æ·»åŠ çš„è§†é¢‘å’Œæ’­æ”¾è®°å½•ã€‚')) {
        localStorage.removeItem('videoPlayerAuth');
        localStorage.removeItem('userVideoSeriesData');
        localStorage.removeItem('playHistory');
        localStorage.removeItem('playbackProgress');
        addStatus('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤', 'success');
        updateStats();
        checkDataJs();
      }
    }

    function goToMainPage() {
      window.location.href = 'index.html';
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    window.onload = function() {
      console.log('è°ƒè¯•é¡µé¢åŠ è½½å®Œæˆ');
      checkDataJs();
      checkLocalStorage();
    };
  </script>
</body>
</html>