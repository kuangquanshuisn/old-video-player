<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>调试视频播放器</title>
  <style>
    body {
      font-family: -apple-system, "Helvetica Neue", Arial, sans-serif;
      padding: 20px;
      background: #f0f0f0;
      margin: 0;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    h2 {
      color: #555;
      margin-top: 30px;
      margin-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 5px;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      border: 1px solid #dee2e6;
      font-size: 13px;
      line-height: 1.5;
      max-height: 400px;
      overflow-y: auto;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
      transition: background 0.2s;
    }
    button:hover {
      background: #0056b3;
    }
    button.danger {
      background: #dc3545;
    }
    button.danger:hover {
      background: #c82333;
    }
    button.success {
      background: #28a745;
    }
    button.success:hover {
      background: #218838;
    }
    .video-item {
      background: #f8f9fa;
      padding: 15px;
      margin: 8px 0;
      border-radius: 4px;
      border: 1px solid #dee2e6;
      cursor: pointer;
      transition: all 0.2s;
    }
    .video-item:hover {
      background: #e9ecef;
      border-color: #adb5bd;
    }
    .video-title {
      font-weight: bold;
      color: #333;
      font-size: 16px;
    }
    .episode-count {
      color: #666;
      font-size: 14px;
      margin-top: 5px;
    }
    .episode-list {
      display: none;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #dee2e6;
    }
    .episode-item {
      display: inline-block;
      padding: 5px 10px;
      margin: 3px;
      background: #e9ecef;
      border-radius: 3px;
      font-size: 12px;
      color: #495057;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .stat-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      border: 1px solid #dee2e6;
      text-align: center;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #007bff;
    }
    .stat-label {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
    .test-video {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 4px;
      border: 1px solid #dee2e6;
    }
    .test-video input {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
    }
    .timestamp {
      font-size: 12px;
      color: #999;
    }
    .console-log {
      background: #263238;
      color: #aed581;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
      margin: 10px 0;
    }
    .log-entry {
      margin: 2px 0;
      padding: 2px 0;
    }
    .log-error {
      color: #ff5252;
    }
    .log-warn {
      color: #ffd54f;
    }
    .log-info {
      color: #64b5f6;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔧 视频播放器调试页面</h1>
    
    <div id="status-container"></div>
    
    <h2>📊 系统状态</h2>
    <div class="stats-grid" id="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="total-series">-</div>
        <div class="stat-label">视频系列总数</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="total-episodes">-</div>
        <div class="stat-label">剧集总数</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="user-series">-</div>
        <div class="stat-label">用户添加系列</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="history-count">-</div>
        <div class="stat-label">播放历史记录</div>
      </div>
    </div>
    
    <h2>🎬 操作按钮</h2>
    <div>
      <button onclick="checkDataJs()">检查 data.js 文件</button>
      <button onclick="checkLocalStorage()">检查本地存储</button>
      <button onclick="testVideoPlayback()">测试视频播放</button>
      <button onclick="exportData()">导出所有数据</button>
      <button onclick="checkVideoUrls()">检查视频链接</button>
      <button class="success" onclick="goToMainPage()">返回主页面</button>
    </div>
    <div style="margin-top: 10px;">
      <button class="danger" onclick="clearAuth()">清除认证信息</button>
      <button class="danger" onclick="clearHistory()">清除播放历史</button>
      <button class="danger" onclick="clearUserVideos()">清除用户视频</button>
      <button class="danger" onclick="clearAllData()">清除所有数据</button>
    </div>
    
    <h2>🎥 测试视频播放</h2>
    <div class="test-video">
      <input type="text" id="test-url" placeholder="输入视频URL进行测试" value="https://cdn.wlcdn88.com:777/20220420/xjPSLTlP/index.m3u8">
      <button onclick="playTestVideo()">播放测试</button>
      <div id="test-result"></div>
    </div>
    
    <h2>📺 视频数据</h2>
    <div id="video-data"></div>
    
    <h2>🖥️ 控制台日志</h2>
    <div class="console-log" id="console-log">
      <div class="log-entry log-info">控制台日志将显示在这里...</div>
    </div>
    
    <h2>🔍 调试信息</h2>
    <pre id="debug-info"></pre>
  </div>

  <script src="data.js"></script>
  <script>
    // 捕获控制台输出
    (function() {
      const logContainer = document.getElementById('console-log');
      const originalLog = console.log;
      const originalError = console.error;
      const originalWarn = console.warn;
      
      function addLogEntry(message, type = 'info') {
        const entry = document.createElement('div');
        entry.className = `log-entry log-${type}`;
        const time = new Date().toLocaleTimeString();
        entry.textContent = `[${time}] ${message}`;
        logContainer.appendChild(entry);
        logContainer.scrollTop = logContainer.scrollHeight;
      }
      
      console.log = function(...args) {
        originalLog.apply(console, args);
        addLogEntry(args.join(' '), 'info');
      };
      
      console.error = function(...args) {
        originalError.apply(console, args);
        addLogEntry(args.join(' '), 'error');
      };
      
      console.warn = function(...args) {
        originalWarn.apply(console, args);
        addLogEntry(args.join(' '), 'warn');
      };
    })();

    function addStatus(message, type = 'info') {
      const container = document.getElementById('status-container');
      const div = document.createElement('div');
      div.className = `status ${type}`;
      const time = new Date().toLocaleTimeString();
      div.innerHTML = `<span>${message}</span><span class="timestamp">${time}</span>`;
      container.appendChild(div);
      
      // 自动清除旧的状态消息
      if (container.children.length > 5) {
        container.removeChild(container.firstChild);
      }
    }

    function updateStats() {
      try {
        // 统计数据
        let totalSeries = 0;
        let totalEpisodes = 0;
        let userSeries = 0;
        
        if (typeof playerData !== 'undefined') {
          totalSeries = playerData.length;
          totalEpisodes = playerData.reduce((sum, series) => sum + series.episodes.length, 0);
        }
        
        const userVideoData = localStorage.getItem('userVideoSeriesData');
        if (userVideoData) {
          const userData = JSON.parse(userVideoData);
          userSeries = userData.length;
          totalSeries += userData.length;
          totalEpisodes += userData.reduce((sum, series) => sum + series.episodes.length, 0);
        }
        
        const playHistory = localStorage.getItem('playHistory');
        const historyCount = playHistory ? JSON.parse(playHistory).length : 0;
        
        // 更新显示
        document.getElementById('total-series').textContent = totalSeries;
        document.getElementById('total-episodes').textContent = totalEpisodes;
        document.getElementById('user-series').textContent = userSeries;
        document.getElementById('history-count').textContent = historyCount;
        
      } catch (e) {
        console.error('更新统计信息失败:', e);
      }
    }

    function checkDataJs() {
      const debugInfo = document.getElementById('debug-info');
      const videoData = document.getElementById('video-data');
      
      try {
        if (typeof playerData !== 'undefined') {
          addStatus(`成功加载 data.js，包含 ${playerData.length} 个视频系列`, 'success');
          console.log(`data.js 加载成功，包含 ${playerData.length} 个视频系列`);
          
          // 显示视频数据
          videoData.innerHTML = '';
          
          // 合并所有数据
          let allData = [...playerData];
          const userVideoData = localStorage.getItem('userVideoSeriesData');
          if (userVideoData) {
            const userData = JSON.parse(userVideoData);
            allData = allData.concat(userData);
          }
          
          allData.forEach((series, index) => {
            const div = document.createElement('div');
            div.className = 'video-item';
            const isUserAdded = index >= playerData.length;
            
            div.innerHTML = `
              <div class="video-title">
                ${index + 1}. ${series.title} 
                ${isUserAdded ? '<span style="color: #28a745;">[用户添加]</span>' : '<span style="color: #007bff;">[系统]</span>'}
              </div>
              <div class="episode-count">共 ${series.episodes.length} 集</div>
              <div class="episode-list" id="episodes-${index}"></div>
            `;
            
            // 点击展开剧集列表
            div.onclick = function() {
              const episodeList = document.getElementById(`episodes-${index}`);
              if (episodeList.style.display === 'block') {
                episodeList.style.display = 'none';
              } else {
                episodeList.style.display = 'block';
                if (episodeList.innerHTML === '') {
                  series.episodes.forEach((ep, epIndex) => {
                    const epDiv = document.createElement('span');
                    epDiv.className = 'episode-item';
                    epDiv.textContent = ep.name;
                    epDiv.title = ep.url;
                    episodeList.appendChild(epDiv);
                  });
                }
              }
            };
            
            videoData.appendChild(div);
          });
          
          // 显示详细数据
          debugInfo.textContent = JSON.stringify(allData, null, 2);
        } else {
          addStatus('错误：playerData 未定义，data.js 可能未正确加载', 'error');
          console.error('playerData 未定义');
          debugInfo.textContent = '无法找到 playerData 变量';
        }
        
        updateStats();
      } catch (e) {
        addStatus(`错误：${e.message}`, 'error');
        console.error('检查 data.js 失败:', e);
        debugInfo.textContent = e.stack;
      }
    }

    function checkLocalStorage() {
      const debugInfo = document.getElementById('debug-info');
      
      try {
        const authData = localStorage.getItem('videoPlayerAuth');
        const userVideoData = localStorage.getItem('userVideoSeriesData');
        const playHistory = localStorage.getItem('playHistory');
        const playbackProgress = localStorage.getItem('playbackProgress');
        
        const data = {
          认证信息: authData ? JSON.parse(authData) : null,
          用户视频数据: userVideoData ? JSON.parse(userVideoData) : null,
          播放历史: playHistory ? JSON.parse(playHistory) : null,
          播放进度: playbackProgress ? JSON.parse(playbackProgress) : null
        };
        
        debugInfo.textContent = JSON.stringify(data, null, 2);
        
        if (authData) {
          const auth = JSON.parse(authData);
          const now = Date.now();
          if (now > auth.expiry) {
            addStatus('认证已过期', 'error');
          } else {
            const daysLeft = Math.round((auth.expiry - now) / (24 * 60 * 60 * 1000));
            addStatus(`认证有效，剩余 ${daysLeft} 天`, 'success');
          }
        } else {
          addStatus('未找到认证信息', 'warning');
        }
        
        if (userVideoData) {
          const userData = JSON.parse(userVideoData);
          addStatus(`找到 ${userData.length} 个用户添加的视频系列`, 'info');
        }
        
        if (playHistory) {
          const history = JSON.parse(playHistory);
          addStatus(`找到 ${history.length} 条播放历史记录`, 'info');
        }
        
        console.log('本地存储检查完成');
        updateStats();
        
      } catch (e) {
        addStatus(`错误：${e.message}`, 'error');
        console.error('检查本地存储失败:', e);
        debugInfo.textContent = e.stack;
      }
    }

    function testVideoPlayback() {
      addStatus('开始测试视频播放功能...', 'info');
      console.log('测试视频播放功能');
      
      // 创建测试播放器
      const testContainer = document.getElementById('test-result');
      testContainer.innerHTML = `
        <video id="test-player" controls style="width: 100%; max-width: 600px; margin-top: 10px;">
          <source src="" type="application/x-mpegURL">
        </video>
      `;
      
      // 测试第一个视频
      if (typeof playerData !== 'undefined' && playerData.length > 0 && playerData[0].episodes.length > 0) {
        const testUrl = playerData[0].episodes[0].url;
        const video = document.getElementById('test-player');
        video.src = testUrl;
        
        video.onloadedmetadata = function() {
          addStatus('视频元数据加载成功', 'success');
          console.log('视频元数据加载成功');
        };
        
        video.onerror = function() {
          addStatus('视频加载失败', 'error');
          console.error('视频加载失败');
        };
        
        addStatus(`正在测试播放: ${playerData[0].title} - ${playerData[0].episodes[0].name}`, 'info');
      } else {
        addStatus('没有可用的视频进行测试', 'warning');
      }
    }

    function playTestVideo() {
      const url = document.getElementById('test-url').value;
      if (!url) {
        addStatus('请输入视频URL', 'warning');
        return;
      }
      
      const testContainer = document.getElementById('test-result');
      testContainer.innerHTML = `
        <video id="test-player" controls style="width: 100%; max-width: 600px; margin-top: 10px;">
          <source src="${url}" type="application/x-mpegURL">
        </video>
      `;
      
      const video = document.getElementById('test-player');
      
      video.onloadedmetadata = function() {
        addStatus('测试视频加载成功', 'success');
        console.log('测试视频加载成功:', url);
      };
      
      video.onerror = function() {
        addStatus('测试视频加载失败', 'error');
        console.error('测试视频加载失败:', url);
      };
      
      video.play().catch(function(e) {
        console.error('播放失败:', e);
      });
    }

    function exportData() {
      try {
        const exportData = {
          playerData: typeof playerData !== 'undefined' ? playerData : [],
          userVideoData: localStorage.getItem('userVideoSeriesData') ? JSON.parse(localStorage.getItem('userVideoSeriesData')) : [],
          playHistory: localStorage.getItem('playHistory') ? JSON.parse(localStorage.getItem('playHistory')) : [],
          playbackProgress: localStorage.getItem('playbackProgress') ? JSON.parse(localStorage.getItem('playbackProgress')) : null,
          exportTime: new Date().toISOString()
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `video-player-data-${new Date().getTime()}.json`;
        link.click();
        
        addStatus('数据导出成功', 'success');
        console.log('数据导出成功');
      } catch (e) {
        addStatus(`导出失败: ${e.message}`, 'error');
        console.error('导出失败:', e);
      }
    }

    function checkVideoUrls() {
      addStatus('开始检查视频链接...', 'info');
      console.log('开始检查视频链接');
      
      let allData = [];
      if (typeof playerData !== 'undefined') {
        allData = [...playerData];
      }
      
      const userVideoData = localStorage.getItem('userVideoSeriesData');
      if (userVideoData) {
        allData = allData.concat(JSON.parse(userVideoData));
      }
      
      let totalVideos = 0;
      let checkedVideos = 0;
      let failedVideos = [];
      
      allData.forEach((series, seriesIndex) => {
        series.episodes.forEach((episode, episodeIndex) => {
          totalVideos++;
          
          // 使用 fetch 检查 URL 是否可访问
          fetch(episode.url, { method: 'HEAD', mode: 'no-cors' })
            .then(() => {
              checkedVideos++;
              console.log(`✓ ${series.title} - ${episode.name}`);
              
              if (checkedVideos === totalVideos) {
                addStatus(`检查完成: ${totalVideos - failedVideos.length}/${totalVideos} 个视频链接有效`, 
                  failedVideos.length > 0 ? 'warning' : 'success');
                
                if (failedVideos.length > 0) {
                  console.error('失败的视频:', failedVideos);
                }
              }
            })
            .catch((error) => {
              checkedVideos++;
              failedVideos.push({
                series: series.title,
                episode: episode.name,
                url: episode.url,
                error: error.message
              });
              console.error(`✗ ${series.title} - ${episode.name}:`, error.message);
              
              if (checkedVideos === totalVideos) {
                addStatus(`检查完成: ${totalVideos - failedVideos.length}/${totalVideos} 个视频链接有效`, 
                  failedVideos.length > 0 ? 'warning' : 'success');
                
                if (failedVideos.length > 0) {
                  console.error('失败的视频:', failedVideos);
                }
              }
            });
        });
      });
      
      if (totalVideos === 0) {
        addStatus('没有视频需要检查', 'warning');
      }
    }

    function clearAuth() {
      if (confirm('确定要清除认证信息吗？下次访问需要重新输入密码。')) {
        localStorage.removeItem('videoPlayerAuth');
        addStatus('认证信息已清除', 'success');
        updateStats();
      }
    }

    function clearHistory() {
      if (confirm('确定要清除播放历史吗？')) {
        localStorage.removeItem('playHistory');
        localStorage.removeItem('playbackProgress');
        addStatus('播放历史已清除', 'success');
        updateStats();
      }
    }

    function clearUserVideos() {
      if (confirm('确定要清除所有用户添加的视频吗？')) {
        localStorage.removeItem('userVideoSeriesData');
        addStatus('用户视频已清除', 'success');
        updateStats();
        checkDataJs();
      }
    }

    function clearAllData() {
      if (confirm('确定要清除所有数据吗？这将删除所有用户添加的视频和播放记录。')) {
        localStorage.removeItem('videoPlayerAuth');
        localStorage.removeItem('userVideoSeriesData');
        localStorage.removeItem('playHistory');
        localStorage.removeItem('playbackProgress');
        addStatus('所有数据已清除', 'success');
        updateStats();
        checkDataJs();
      }
    }

    function goToMainPage() {
      window.location.href = 'index.html';
    }

    // 页面加载时自动检查
    window.onload = function() {
      console.log('调试页面加载完成');
      checkDataJs();
      checkLocalStorage();
    };
  </script>
</body>
</html>