<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <title>视频在线播放</title>
  <!-- Video.js 5.20.5 - Last version with good iOS 9 support -->
  <link href="https://cdn.jsdelivr.net/npm/video.js@5.20.5/dist/video-js.min.css" rel="stylesheet" />
  <style>
  /* iOS 9 兼容的CSS */
  body {
    font-family: -apple-system, "Helvetica Neue", Arial, sans-serif;
    background: #f4f6f9;
    color: #1f2937;
    margin: 0;
    height: 100vh;
    overflow: hidden;
    font-size: 14px;
    -webkit-text-size-adjust: 100%;
    -webkit-tap-highlight-color: transparent;
  }

  * {
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
  }

  /* 主布局 - 使用flexbox的旧语法以支持iOS 9 */
  .container {
    display: -webkit-flex;
    display: flex;
    width: 100%;
    height: 100%;
    display: none;
  }

  .sidebar {
    width: 280px;
    background: #ffffff;
    border-right: 1px solid #e5e7eb;
    display: -webkit-flex;
    display: flex;
    -webkit-flex-direction: column;
    flex-direction: column;
    -webkit-flex-shrink: 0;
    flex-shrink: 0;
  }

  .main-content {
    -webkit-flex: 1;
    flex: 1;
    padding: 24px;
    display: -webkit-flex;
    display: flex;
    -webkit-flex-direction: column;
    flex-direction: column;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    position: relative;
  }

  /* 侧边栏样式 */
  .sidebar-tabs {
    display: -webkit-flex;
    display: flex;
    padding: 4px;
    background: #f8f9fa;
    border-bottom: 1px solid #e5e7eb;
  }

  .sidebar-tab {
    -webkit-flex: 1;
    flex: 1;
    padding: 8px 12px;
    text-align: center;
    cursor: pointer;
    font-weight: 500;
    color: #6b7280;
    border-radius: 4px;
    -webkit-transition: all 0.2s ease;
    transition: all 0.2s ease;
    -webkit-user-select: none;
    user-select: none;
  }

  .sidebar-tab:active {
    background-color: #e9ecef;
  }

  .sidebar-tab.active {
    background-color: #ffffff;
    color: #007bff;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  }

  .sidebar-content {
    padding: 16px;
    -webkit-flex: 1;
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    position: relative;
    padding-bottom: 80px;
  }

  .sidebar ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .sidebar li {
    padding: 12px;
    cursor: pointer;
    border-radius: 8px;
    margin-bottom: 8px;
    -webkit-transition: background-color 0.2s ease;
    transition: background-color 0.2s ease;
    position: relative;
    display: -webkit-flex;
    display: flex;
    -webkit-align-items: center;
    align-items: center;
    -webkit-justify-content: space-between;
    justify-content: space-between;
    font-weight: 500;
    font-size: 18px;
  }

  .sidebar li:active {
    background-color: #f8f9fa;
  }

  .sidebar li.active {
    background-color: #007bff;
    color: #ffffff;
    font-weight: 600;
  }

  .series-name {
    -webkit-flex: 1;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .delete-btn {
    background: transparent;
    color: #dc3545;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    display: none;
    -webkit-align-items: center;
    align-items: center;
    -webkit-justify-content: center;
    justify-content: center;
    margin-left: 8px;
  }

  .sidebar li:hover .delete-btn { 
    display: -webkit-flex;
    display: flex; 
  }

  .add-video-btn {
    position: absolute;
    bottom: 20px;
    left: 16px;
    right: 16px;
    height: 44px;
    background: #28a745;
    color: #ffffff;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    display: -webkit-flex;
    display: flex;
    -webkit-align-items: center;
    align-items: center;
    -webkit-justify-content: center;
    justify-content: center;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  .add-video-btn:active {
    -webkit-transform: scale(0.98);
    transform: scale(0.98);
  }

  /* 播放历史样式 */
  .history-item {
    padding: 12px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
  }

  .history-item:active {
    border-color: #007bff;
    background-color: #e6f2ff;
  }

  .history-title { 
    font-weight: 600; 
    color: #1f2937; 
    margin-bottom: 4px; 
  }

  .history-episode { 
    font-size: 13px; 
    color: #6b7280; 
    margin-bottom: 4px; 
  }

  .history-progress { 
    font-size: 12px; 
    color: #007bff; 
    display: -webkit-flex;
    display: flex; 
    -webkit-justify-content: space-between;
    justify-content: space-between; 
    -webkit-align-items: center;
    align-items: center; 
  }

  .history-time { 
    color: #6b7280; 
  }

  .history-clear {
    width: 100%;
    padding: 8px;
    background-color: #fbebee;
    color: #dc3545;
    border: 1px solid #dc3545;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    margin-top: 16px;
    font-weight: 500;
  }

  .history-clear:active { 
    background-color: #dc3545; 
    color: #ffffff; 
  }

  .no-history { 
    text-align: center; 
    color: #6b7280; 
    padding: 32px 0; 
  }

  /* 播放器容器 */
  .player-container {
    position: relative;
    width: 100%;
    max-width: 1000px;
    margin: 0 auto;
    background: #000;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    -webkit-flex-shrink: 0; /* 防止播放器被压缩 */
    flex-shrink: 0;
  }

  /* Video.js 样式覆盖 */
  .video-js {
    width: 100%;
    height: 0;
    padding-top: 56.25%; /* 16:9 */
    border-radius: 12px;
    overflow: hidden;
  }

  .video-js .vjs-big-play-button {
    font-size: 3em;
    line-height: 1.5em;
    height: 1.5em;
    width: 3em;
    border: 0.06666em solid #fff;
    border-radius: 0.3em;
    left: 50%;
    top: 50%;
    margin-left: -1.5em;
    margin-top: -0.75em;
  }

  .combined-title {
    text-align: center;
    margin: 8px 0 24px;
    font-size: 22px;
    font-weight: 600;
    color: #1f2937;
    -webkit-flex-shrink: 0; /* 防止标题被压缩 */
    flex-shrink: 0;
  }

  .episode-list {
    display: -webkit-flex;
    display: flex;
    -webkit-flex-wrap: wrap;
    flex-wrap: wrap;
    gap: 8px;
    padding: 20px;
    -webkit-justify-content: flex-start;
    justify-content: flex-start;
    max-width: 1000px;
    width: 100%;
    margin: 0 auto 20px;
    max-height: 200px; /* 限制最大高度 */
    overflow-y: auto; /* 添加垂直滚动 */
    -webkit-overflow-scrolling: touch; /* iOS 9 平滑滚动 */
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
  }
  
  /* 剧集列表滚动条样式 */
  .episode-list::-webkit-scrollbar {
    width: 6px;
  }
  
  .episode-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
  }
  
  .episode-list::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
  }
  
  .episode-list::-webkit-scrollbar-thumb:hover {
    background: #555;
  }

  .episode-btn {
    padding: 8px 16px;
    border: 1px solid #e5e7eb;
    background-color: #ffffff;
    color: #6b7280;
    cursor: pointer;
    border-radius: 8px;
    font-size: 14px;
    position: relative;
    font-weight: 500;
    -webkit-transition: all 0.2s ease;
    transition: all 0.2s ease;
  }

  .episode-btn:active {
    border-color: #007bff;
    color: #007bff;
  }

  .episode-btn.active {
    background-color: #007bff;
    color: #ffffff;
    border-color: #007bff;
    font-weight: 600;
  }

  .episode-delete {
    position: absolute;
    top: -10px;
    right: -10px;
    background: #dc3545;
    color: #ffffff;
    border: 2px solid #ffffff;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    font-size: 12px;
    cursor: pointer;
    display: none;
    -webkit-align-items: center;
    align-items: center;
    -webkit-justify-content: center;
    justify-content: center;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  }

  .episode-btn:hover .episode-delete { 
    display: -webkit-flex;
    display: flex; 
  }

  .add-episode-btn {
    padding: 8px 16px;
    border: 2px dashed #28a745;
    background-color: transparent;
    color: #28a745;
    cursor: pointer;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
  }

  .add-episode-btn:active { 
    background-color: #28a745; 
    color: #ffffff; 
  }

  /* 密码覆盖层 */
  #password-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: -webkit-flex;
    display: flex;
    -webkit-justify-content: center;
    justify-content: center;
    -webkit-align-items: center;
    align-items: center;
    z-index: 9999;
    display: none;
  }

  .password-modal {
    background: #ffffff;
    padding: 32px;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    text-align: center;
  }

  .password-modal h2 { 
    margin-top: 0; 
    margin-bottom: 20px; 
    color: #1f2937; 
  }

  .password-modal input {
    padding: 12px;
    width: 220px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 16px;
    margin-right: 8px;
  }

  .password-modal input:focus {
    outline: none;
    border-color: #007bff;
  }

  .password-modal button {
    padding: 12px 20px;
    font-size: 16px;
    cursor: pointer;
    background-color: #007bff;
    color: #ffffff;
    border: none;
    border-radius: 8px;
  }

  .password-modal button:active { 
    background-color: #0069d9; 
  }

  .password-modal p.error { 
    color: #dc3545; 
    height: 16px; 
    margin-top: 12px; 
    margin-bottom: 0; 
  }

  #restore-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    color: #ffffff;
    font-size: 18px;
    line-height: 1.5;
    display: -webkit-flex;
    display: flex;
    -webkit-flex-direction: column;
    flex-direction: column;
    -webkit-justify-content: center;
    justify-content: center;
    -webkit-align-items: center;
    align-items: center;
    text-align: center;
    cursor: pointer;
    z-index: 10;
    display: none;
  }

  /* 弹窗样式 */
  #add-video-overlay, #add-episode-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: -webkit-flex;
    display: flex;
    -webkit-justify-content: center;
    justify-content: center;
    -webkit-align-items: center;
    align-items: center;
    z-index: 9998;
    display: none;
  }

  .add-video-modal, .add-episode-modal {
    background: #ffffff;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    width: 90%;
    max-width: 500px;
  }

  .add-video-modal h3, .add-episode-modal h3 {
    margin-top: 0;
    margin-bottom: 24px;
    color: #1f2937;
    text-align: center;
    font-size: 20px;
  }

  .form-group { 
    margin-bottom: 16px; 
  }

  .form-group label { 
    display: block; 
    margin-bottom: 8px; 
    font-weight: 500; 
    color: #1f2937; 
  }

  .form-group input {
    width: 100%;
    padding: 12px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
  }

  .form-group input:focus {
    outline: none;
    border-color: #007bff;
  }

  .episode-inputs {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    background: #f8f9fa;
  }

  .episode-inputs h4 { 
    margin: 0 0 16px 0; 
    color: #1f2937; 
    font-size: 14px; 
    font-weight: 500;
  }

  .episode-input-group { 
    display: -webkit-flex;
    display: flex; 
    gap: 8px; 
    margin-bottom: 8px; 
    -webkit-align-items: center;
    align-items: center; 
  }

  .episode-input-group input { 
    -webkit-flex: 1;
    flex: 1; 
    margin-bottom: 0; 
  }

  .remove-episode-btn {
    background: #fbebee;
    color: #dc3545;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    -webkit-flex-shrink: 0;
    flex-shrink: 0;
  }

  .remove-episode-btn:active { 
    background: #dc3545; 
    color: #ffffff; 
  }

  .add-episode-input-btn {
    background: transparent;
    color: #28a745;
    border: 1px solid #28a745;
    border-radius: 8px;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    margin-top: 8px;
  }

  .add-episode-input-btn:active { 
    background-color: #28a745; 
    color: #ffffff; 
  }

  .modal-buttons { 
    display: -webkit-flex;
    display: flex; 
    -webkit-justify-content: flex-end;
    justify-content: flex-end; 
    gap: 12px; 
    margin-top: 24px; 
  }

  .modal-buttons button {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
  }

  .btn-cancel { 
    background: #f8f9fa; 
    color: #6b7280; 
  }

  .btn-cancel:active { 
    background: #e9ecef; 
  }

  .btn-save { 
    background: #007bff; 
    color: #ffffff; 
  }

  .btn-save:active { 
    background-color: #0069d9; 
  }

  /* 空状态 */
  .empty-state {
    text-align: center;
    color: #6b7280;
    font-size: 16px;
    padding: 80px 20px;
    display: none;
    -webkit-flex: 1;
    flex: 1;
    -webkit-justify-content: center;
    justify-content: center;
    -webkit-align-items: center;
    align-items: center;
    -webkit-flex-direction: column;
    flex-direction: column;
  }

  .empty-state p { 
    margin-bottom: 20px; 
    line-height: 1.6; 
  }

  /* iOS 9 特定优化 */
  @supports (-webkit-overflow-scrolling: touch) {
    .sidebar-content,
    .main-content,
    .episode-list {
      -webkit-overflow-scrolling: touch;
    }
  }
  
  /* 小屏幕设备优化 */
  @media (max-width: 768px) {
    .episode-list {
      max-height: 150px; /* 移动设备上更小的高度 */
      padding: 12px;
    }
    
    .main-content {
      padding: 16px;
    }
    
    .combined-title {
      font-size: 18px;
      margin: 8px 0 16px;
    }
  }

  /* 防止iOS弹性滚动 */
  html, body {
    position: fixed;
    overflow: hidden;
    width: 100%;
    height: 100%;
  }
  </style>
</head>
<body>

  <div id="password-overlay">
    <div class="password-modal">
      <h2>请输入访问密码</h2>
      <div>
        <input type="password" id="password-input" placeholder="密码">
        <button id="password-submit">进入</button>
      </div>
      <p id="password-error" class="error"></p>
    </div>
  </div>

  <!-- 添加视频弹窗 -->
  <div id="add-video-overlay">
    <div class="add-video-modal">
      <h3>添加视频系列</h3>
      <form id="add-video-form">
        <div class="form-group">
          <label for="series-title-input">系列标题:</label>
          <input type="text" id="series-title-input" placeholder="请输入视频系列标题" required>
        </div>
        
        <div class="episode-inputs">
          <h4>剧集列表:</h4>
          <div id="episode-inputs-container">
            <div class="episode-input-group">
              <input type="text" placeholder="剧集名称 (如: 第1集)" required>
              <input type="url" placeholder="视频地址 (http://... 或 https://...)" required>
              <button type="button" class="remove-episode-btn" onclick="removeEpisodeInput(this)">-</button>
            </div>
          </div>
          <button type="button" class="add-episode-input-btn" onclick="addEpisodeInput()">+ 添加剧集</button>
        </div>
        
        <div class="modal-buttons">
          <button type="button" class="btn-cancel" onclick="closeAddVideoModal()">取消</button>
          <button type="submit" class="btn-save">保存</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 添加剧集弹窗 -->
  <div id="add-episode-overlay">
    <div class="add-episode-modal">
      <h3>添加剧集</h3>
      <form id="add-episode-form">
        <div class="form-group">
          <label for="episode-name-input">剧集名称:</label>
          <input type="text" id="episode-name-input" placeholder="请输入剧集名称（如：第1集）" required>
        </div>
        
        <div class="form-group">
          <label for="episode-url-input">视频地址:</label>
          <input type="url" id="episode-url-input" placeholder="请输入视频地址（http://... 或 https://...）" required>
        </div>
        
        <div class="modal-buttons">
          <button type="button" class="btn-cancel" onclick="closeAddEpisodeModal()">取消</button>
          <button type="submit" class="btn-save">保存</button>
        </div>
      </form>
    </div>
  </div>

  <div class="container">
    <div class="sidebar">
      <div class="sidebar-tabs">
        <div class="sidebar-tab active" data-tab="series" onclick="switchTab('series')">视频列表</div>
        <div class="sidebar-tab" data-tab="history" onclick="switchTab('history')">播放历史</div>
      </div>
      <div class="sidebar-content">
        <div id="series-tab" class="tab-content" style="display: block;">
          <ul id="series-list"></ul>
          <button class="add-video-btn" onclick="openAddVideoModal()">+ 添加视频</button>
        </div>
        <div id="history-tab" class="tab-content" style="display: none;">
          <div id="history-list"></div>
          <button id="clear-history" class="history-clear">清除历史记录</button>
        </div>
      </div>
    </div>
    <div class="main-content">
      <h1 id="combined-title" class="combined-title"></h1>
      <div class="player-container">
        <video id="my-video" class="video-js vjs-default-skin vjs-big-play-centered" controls preload="auto" playsinline webkit-playsinline></video>
        <div id="restore-overlay"></div>
      </div>
      <div id="episode-list" class="episode-list"></div>
      <div id="empty-state" class="empty-state" style="display: none;">
        <p>还没有添加任何视频</p>
        <p>点击左侧的"+ 添加视频"按钮开始添加视频系列</p>
      </div>
    </div>
  </div>

  <!-- Video.js 5.20.5 - iOS 9 兼容版本 -->
  <script src="https://cdn.jsdelivr.net/npm/video.js@5.20.5/dist/video.min.js"></script>
  <!-- HLS 支持 -->
  <script src="https://cdn.jsdelivr.net/npm/videojs-contrib-hls@5.15.0/dist/videojs-contrib-hls.min.js"></script>
  <!-- 加载视频数据 -->
  <script src="data.js"></script>
  <script>
    // 检查 playerData 是否加载成功
    if (typeof playerData === 'undefined') {
      console.error('错误：data.js 文件未正确加载或 playerData 未定义');
    } else {
      console.log('data.js 加载成功，包含', playerData.length, '个视频系列');
    }
    
    // iOS 9 兼容的JavaScript代码
    (function() {
      'use strict';
      
      // 全局变量
      var seriesData = [];
      var currentSeriesIndex = 0;
      var currentEpisodeIndex = 0;
      var player = null;

      // Polyfill for Array.from (iOS 9)
      if (!Array.from) {
        Array.from = function(arrayLike) {
          return Array.prototype.slice.call(arrayLike);
        };
      }

      // Polyfill for Array.prototype.find (iOS 9)
      if (!Array.prototype.find) {
        Array.prototype.find = function(predicate) {
          if (this == null) {
            throw new TypeError('Array.prototype.find called on null or undefined');
          }
          if (typeof predicate !== 'function') {
            throw new TypeError('predicate must be a function');
          }
          var list = Object(this);
          var length = list.length >>> 0;
          var thisArg = arguments[1];
          var value;

          for (var i = 0; i < length; i++) {
            value = list[i];
            if (predicate.call(thisArg, value, i, list)) {
              return value;
            }
          }
          return undefined;
        };
      }

      // Polyfill for Array.prototype.findIndex (iOS 9)
      if (!Array.prototype.findIndex) {
        Array.prototype.findIndex = function(predicate) {
          if (this == null) {
            throw new TypeError('Array.prototype.findIndex called on null or undefined');
          }
          if (typeof predicate !== 'function') {
            throw new TypeError('predicate must be a function');
          }
          var list = Object(this);
          var length = list.length >>> 0;
          var thisArg = arguments[1];
          var value;

          for (var i = 0; i < length; i++) {
            value = list[i];
            if (predicate.call(thisArg, value, i, list)) {
              return i;
            }
          }
          return -1;
        };
      }

      // 加载数据函数
      function loadSeriesData() {
        try {
          console.log('开始加载视频数据...');
          
          var savedUserData = localStorage.getItem('userVideoSeriesData');
          var userData = [];
          
          if (savedUserData) {
            userData = JSON.parse(savedUserData);
            console.log('加载的用户自定义数据:', userData);
          }
          
          var dataJsContent = [];
          if (typeof playerData !== 'undefined' && Array.isArray(playerData)) {
            dataJsContent = playerData.slice();
            console.log('加载的data.js数据:', dataJsContent);
          } else {
            console.error('警告：playerData 未定义或不是数组');
            console.log('typeof playerData:', typeof playerData);
            console.log('playerData:', playerData);
          }
          
          seriesData = dataJsContent.concat(userData);
          console.log('最终合并的数据:', seriesData);
          console.log('seriesData长度:', seriesData.length);
          
        } catch (e) {
          console.error('加载视频数据失败:', e);
          if (typeof playerData !== 'undefined') {
            seriesData = playerData.slice();
          } else {
            seriesData = [];
          }
        }
      }

      // 保存数据函数
      function saveSeriesData() {
        try {
          var dataJsCount = 0;
          if (typeof playerData !== 'undefined' && Array.isArray(playerData)) {
            dataJsCount = playerData.length;
          }
          
          var userData = seriesData.slice(dataJsCount);
          localStorage.setItem('userVideoSeriesData', JSON.stringify(userData));
          console.log('保存用户数据:', userData);
          
        } catch (e) {
          console.error('保存视频数据失败:', e);
        }
      }

      // 渲染系列列表
      function renderSeriesList() {
        console.log('开始渲染系列列表...');
        var seriesListEl = document.getElementById('series-list');
        
        if (!seriesListEl) {
          console.error('错误：找不到 series-list 元素');
          return;
        }
        
        seriesListEl.innerHTML = '';
        
        console.log('当前 seriesData 长度:', seriesData.length);
        
        if (seriesData.length === 0) {
          console.log('没有视频数据，显示空状态');
          showEmptyState();
          return;
        }
        
        hideEmptyState();
        
        var dataJsCount = 0;
        if (typeof playerData !== 'undefined' && Array.isArray(playerData)) {
          dataJsCount = playerData.length;
        }
        
        console.log('开始渲染视频列表，共', seriesData.length, '个系列');
        
        seriesData.forEach(function(series, index) {
          console.log('渲染系列', index + 1, ':', series.title);
          var li = document.createElement('li');
          var isFromDataJs = index < dataJsCount;
          
          var html = '<span class="series-name">' + series.title + '</span>';
          if (!isFromDataJs) {
            html += '<button class="delete-btn" onclick="deleteSeries(' + index + ', event)">×</button>';
          }
          
          li.innerHTML = html;
          li.addEventListener('click', function() {
            console.log('点击系列:', series.title, '索引:', index);
            displayEpisodes(index);
            
            // 查找最后播放的剧集
            var lastPlayed = findLastPlayedEpisodeForSeries(index);
            if (lastPlayed) {
              console.log('找到播放记录，剧集:', lastPlayed.episodeIndex, '时间:', lastPlayed.time);
              playEpisode(index, lastPlayed.episodeIndex, lastPlayed.time);
            } else {
              console.log('没有播放记录，播放第一集');
              playEpisode(index, 0);
            }
          });
          seriesListEl.appendChild(li);
        });
        
        console.log('系列列表渲染完成');
        updateActiveStates();
      }

      // 查找系列的最后播放记录
      function findLastPlayedEpisodeForSeries(seriesIdx) {
        var history = [];
        try {
          var savedHistory = localStorage.getItem('playHistory');
          if (savedHistory) {
            history = JSON.parse(savedHistory);
          }
        } catch (e) {
          console.error('加载播放历史失败:', e);
          return null;
        }

        for (var i = 0; i < history.length; i++) {
          if (history[i].seriesIndex === seriesIdx) {
            if (seriesData[history[i].seriesIndex] &&
                seriesData[history[i].seriesIndex].episodes[history[i].episodeIndex]) {
              return {
                episodeIndex: history[i].episodeIndex,
                time: history[i].currentTime
              };
            }
          }
        }
        return null;
      }

      // 显示空状态
      function showEmptyState() {
        document.getElementById('empty-state').style.display = 'block';
        document.querySelector('.player-container').style.display = 'none';
        document.getElementById('episode-list').style.display = 'none';
        document.getElementById('combined-title').textContent = '';
      }

      // 隐藏空状态
      function hideEmptyState() {
        document.getElementById('empty-state').style.display = 'none';
        document.querySelector('.player-container').style.display = 'block';
        document.getElementById('episode-list').style.display = 'flex';
      }

      // 播放剧集
      function playEpisode(seriesIdx, episodeIdx, startTime) {
        console.log('playEpisode调用:', seriesIdx, episodeIdx, startTime);
        
        if (!seriesData[seriesIdx] || !seriesData[seriesIdx].episodes[episodeIdx]) {
          console.error('视频不存在', seriesIdx, episodeIdx);
          return;
        }
        
        if (!player) {
          console.error('播放器未初始化');
          return;
        }
        
        var restoreOverlay = document.getElementById('restore-overlay');
        var pendingSeekTime = null;
        restoreOverlay.style.display = 'none';
        currentSeriesIndex = seriesIdx;
        currentEpisodeIndex = episodeIdx;
        
        var episode = seriesData[seriesIdx].episodes[episodeIdx];
        var seriesTitle = seriesData[seriesIdx].title;
        document.getElementById('combined-title').textContent = seriesTitle + ' - ' + episode.name;
        
        console.log('准备播放:', episode.name, episode.url);
        
        // 检测视频类型
        var videoType = 'application/x-mpegURL';
        if (episode.url.indexOf('.mp4') > -1) {
          videoType = 'video/mp4';
        }
        
        // 设置视频源
        player.src({
          src: episode.url,
          type: videoType
        });
        
        // iOS检测
        var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        
        if (startTime !== null && startTime !== undefined && startTime > 0) {
          pendingSeekTime = startTime;
          
          // iOS 9 特殊处理：需要等待更多事件确保视频准备就绪
          var handleTimeSeek = function() {
            if (isIOS) {
              // iOS需要用户交互才能跳转，显示恢复提示
              var timeStr = formatTime(startTime);
              restoreOverlay.innerHTML = '上次播放至 ' + timeStr + '<br>点击屏幕继续播放';
              restoreOverlay.style.display = 'flex';
              
              // 设置点击事件处理
              restoreOverlay.onclick = function() {
                restoreOverlay.style.display = 'none';
                
                // iOS 9 优化：先尝试设置时间，再播放
                try {
                  player.currentTime(pendingSeekTime);
                } catch (e) {
                  console.log('预设时间失败，播放后再跳转:', e);
                }
                
                // 播放视频
                var playPromise = player.play();
                
                // iOS 9 兼容：检查是否返回Promise
                if (playPromise && typeof playPromise.then === 'function') {
                  playPromise.then(function() {
                    // 播放成功后再次尝试跳转
                    setTimeout(function() {
                      console.log('iOS恢复播放：跳转到 ' + pendingSeekTime + '秒');
                      player.currentTime(pendingSeekTime);
                      pendingSeekTime = null;
                    }, 200); // iOS 9 需要更长的延迟
                  }).catch(function(e) {
                    console.error('播放失败:', e);
                  });
                } else {
                  // 旧版本浏览器不返回Promise
                  setTimeout(function() {
                    console.log('iOS恢复播放：跳转到 ' + pendingSeekTime + '秒');
                    player.currentTime(pendingSeekTime);
                    pendingSeekTime = null;
                  }, 300); // iOS 9 需要更长的延迟
                }
              };
            } else {
              // 非iOS设备直接跳转
              player.currentTime(startTime);
              var playPromise = player.play();
              if (playPromise && typeof playPromise.then === 'function') {
                playPromise.catch(function(e) {
                  console.error('播放失败:', e);
                });
              }
            }
          };
          
          // iOS 9 兼容：监听多个事件确保视频准备就绪
          if (isIOS) {
            var metadataLoaded = false;
            var canPlayLoaded = false;
            
            var checkReady = function() {
              if (metadataLoaded && canPlayLoaded) {
                handleTimeSeek();
              }
            };
            
            player.one('loadedmetadata', function() {
              console.log('iOS 9: loadedmetadata 事件触发');
              metadataLoaded = true;
              checkReady();
            });
            
            player.one('canplay', function() {
              console.log('iOS 9: canplay 事件触发');
              canPlayLoaded = true;
              checkReady();
            });
            
            // 备用方案：如果事件没有触发，使用定时器
            setTimeout(function() {
              if (!metadataLoaded || !canPlayLoaded) {
                console.log('iOS 9: 使用备用方案处理时间跳转');
                handleTimeSeek();
              }
            }, 1000);
          } else {
            player.one('loadedmetadata', handleTimeSeek);
          }
        } else {
          // 没有指定时间，直接播放
          var playPromise = player.play();
          if (playPromise && typeof playPromise.then === 'function') {
            playPromise.catch(function(e) {
              console.error('自动播放失败:', e);
              // 如果自动播放失败，显示提示
              restoreOverlay.innerHTML = '点击屏幕开始播放';
              restoreOverlay.style.display = 'flex';
              restoreOverlay.onclick = function() {
                restoreOverlay.style.display = 'none';
                player.play();
              };
            });
          }
        }
        
        updateActiveStates();
      }

      // 显示剧集列表
      function displayEpisodes(seriesIdx) {
        if (!seriesData[seriesIdx]) return;
        
        currentSeriesIndex = seriesIdx;
        var series = seriesData[seriesIdx];
        var episodeListEl = document.getElementById('episode-list');
        episodeListEl.innerHTML = '';
        
        var dataJsCount = 0;
        if (typeof playerData !== 'undefined' && Array.isArray(playerData)) {
          dataJsCount = playerData.length;
        }
        var isFromDataJs = seriesIdx < dataJsCount;
        
        series.episodes.forEach(function(episode, index) {
          var btn = document.createElement('button');
          btn.className = 'episode-btn';
          
          var html = episode.name;
          if (!isFromDataJs) {
            html += '<button class="episode-delete" onclick="deleteEpisode(' + seriesIdx + ', ' + index + ', event)">×</button>';
          }
          
          btn.innerHTML = html;
          btn.addEventListener('click', function(e) {
            if (e.target.className !== 'episode-delete') {
              console.log('点击剧集:', episode.name, '索引:', index);
              var historyTime = findHistoryForEpisode(seriesIdx, index);
              console.log('找到的历史播放时间:', historyTime);
              // 确保播放器已初始化
              if (player) {
                playEpisode(seriesIdx, index, historyTime);
              } else {
                console.error('播放器未初始化，无法播放');
                alert('播放器未初始化，请刷新页面重试');
              }
            }
          });
          episodeListEl.appendChild(btn);
        });
        
        if (!isFromDataJs) {
          var addBtn = document.createElement('button');
          addBtn.className = 'add-episode-btn';
          addBtn.textContent = '+ 添加剧集';
          addBtn.addEventListener('click', function() {
            openAddEpisodeModal();
          });
          episodeListEl.appendChild(addBtn);
        }
        
        updateActiveStates();
      }

      // 查找剧集历史
      function findHistoryForEpisode(seriesIdx, episodeIdx) {
        var history = [];
        try {
          var savedHistory = localStorage.getItem('playHistory');
          if (savedHistory) {
            history = JSON.parse(savedHistory);
          }
        } catch (e) {
          console.error('加载播放历史失败:', e);
          return null;
        }
        
        for (var i = 0; i < history.length; i++) {
          var item = history[i];
          if (item.seriesIndex === seriesIdx && item.episodeIndex === episodeIdx) {
            if (item.duration > 0 && (item.currentTime / item.duration) > 0.95) {
              return null;
            }
            return item.currentTime;
          }
        }
        return null;
      }

      // 更新活跃状态
      function updateActiveStates() {
        var seriesListEl = document.getElementById('series-list');
        var episodeListEl = document.getElementById('episode-list');
        
        Array.from(seriesListEl.children).forEach(function(li, index) {
          if (li.tagName === 'LI') {
            if (index === currentSeriesIndex) {
              li.classList.add('active');
            } else {
              li.classList.remove('active');
            }
          }
        });
        
        Array.from(episodeListEl.children).forEach(function(btn, index) {
          if (btn.className.indexOf('episode-btn') !== -1) {
            if (index === currentEpisodeIndex) {
              btn.classList.add('active');
            } else {
              btn.classList.remove('active');
            }
          }
        });
      }

      // 保存播放进度
      function saveProgress() {
        if (!player) return;
        
        var time = player.currentTime();
        if (isNaN(time) || time < 1) return;
        
        var progress = {
          seriesIndex: currentSeriesIndex,
          episodeIndex: currentEpisodeIndex,
          time: time
        };
        localStorage.setItem('playbackProgress', JSON.stringify(progress));
        
        saveToHistory(currentSeriesIndex, currentEpisodeIndex, time);
      }

      // 保存到历史记录
      function saveToHistory(seriesIdx, episodeIdx, time) {
        if (!seriesData[seriesIdx] || !seriesData[seriesIdx].episodes[episodeIdx]) return;
        
        var series = seriesData[seriesIdx];
        var episode = series.episodes[episodeIdx];
        var duration = player ? player.duration() : 0;
        
        var historyItem = {
          seriesIndex: seriesIdx,
          episodeIndex: episodeIdx,
          seriesTitle: series.title,
          episodeName: episode.name,
          currentTime: time,
          duration: duration,
          timestamp: Date.now(),
          watchDate: new Date().toLocaleDateString('zh-CN')
        };
        
        var history = [];
        try {
          var savedHistory = localStorage.getItem('playHistory');
          if (savedHistory) {
            history = JSON.parse(savedHistory);
          }
        } catch (e) {
          console.error('解析播放历史失败:', e);
        }

        var existingIndex = -1;
        for (var i = 0; i < history.length; i++) {
          if (history[i].seriesIndex === seriesIdx && history[i].episodeIndex === episodeIdx) {
            existingIndex = i;
            break;
          }
        }
        
        if (existingIndex >= 0) {
          history.splice(existingIndex, 1);
        }
        
        history.unshift(historyItem);
        
        if (history.length > 50) {
          history = history.slice(0, 50);
        }
        
        localStorage.setItem('playHistory', JSON.stringify(history));
      }

      // 格式化时间
      function formatTime(totalSeconds) {
        var minutes = Math.floor(totalSeconds / 60);
        var seconds = Math.floor(totalSeconds % 60);
        return (minutes < 10 ? '0' : '') + minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
      }

      // 显示历史记录
      function displayHistory() {
        var history = [];
        try {
          var savedHistory = localStorage.getItem('playHistory');
          if (savedHistory) {
            history = JSON.parse(savedHistory);
          }
        } catch (e) {
          console.error('加载播放历史失败:', e);
        }
        
        var historyListEl = document.getElementById('history-list');
        historyListEl.innerHTML = '';
        
        if (history.length === 0) {
          historyListEl.innerHTML = '<div class="no-history">暂无播放历史</div>';
          return;
        }
        
        // 过滤掉已删除的视频
        history = history.filter(function(item) {
          return seriesData[item.seriesIndex] &&
                 seriesData[item.seriesIndex].episodes[item.episodeIndex];
        });
        
        localStorage.setItem('playHistory', JSON.stringify(history));
        
        if (history.length === 0) {
          historyListEl.innerHTML = '<div class="no-history">暂无播放历史</div>';
          return;
        }
        
        history.forEach(function(item) {
          var historyItem = document.createElement('div');
          historyItem.className = 'history-item';
          
          var progressPercent = item.duration > 0 ? (item.currentTime / item.duration * 100).toFixed(1) : 0;
          var currentTimeStr = formatTime(item.currentTime);
          var durationStr = item.duration > 0 ? formatTime(item.duration) : '--:--';
          
          historyItem.innerHTML =
            '<div class="history-title">' + item.seriesTitle + '</div>' +
            '<div class="history-episode">' + item.episodeName + '</div>' +
            '<div class="history-progress">' +
              '<span>播放至 ' + currentTimeStr + ' / ' + durationStr + ' (' + progressPercent + '%)</span>' +
              '<span class="history-time">' + item.watchDate + '</span>' +
            '</div>';
          
          historyItem.addEventListener('click', function() {
            console.log('点击历史记录:', item.seriesTitle, item.episodeName, '时间:', item.currentTime);
            switchTab('series');
            
            // 先显示剧集列表
            displayEpisodes(item.seriesIndex);
            
            // 延迟播放以确保UI更新完成
            setTimeout(function() {
              // 确保播放器已初始化
              if (player) {
                playEpisode(item.seriesIndex, item.episodeIndex, item.currentTime);
              } else {
                console.error('播放器未初始化');
                alert('播放器未就绪，请稍后重试');
              }
            }, 100);
          });
          
          historyListEl.appendChild(historyItem);
        });
      }

      // 全局函数定义
      window.deleteSeries = function(index, event) {
        event.stopPropagation();
        
        var dataJsCount = 0;
        if (typeof playerData !== 'undefined' && Array.isArray(playerData)) {
          dataJsCount = playerData.length;
        }
        
        if (index < dataJsCount) {
          alert('无法删除来自data.js的视频系列');
          return;
        }
        
        if (confirm('确定要删除这个视频系列吗？')) {
          seriesData.splice(index, 1);
          saveSeriesData();
          renderSeriesList();
          
          if (index === currentSeriesIndex) {
            if (seriesData.length > 0) {
              currentSeriesIndex = Math.min(currentSeriesIndex, seriesData.length - 1);
              displayEpisodes(currentSeriesIndex);
              playEpisode(currentSeriesIndex, 0);
            } else {
              showEmptyState();
            }
          } else if (index < currentSeriesIndex) {
            currentSeriesIndex--;
          }
        }
      };

      window.deleteEpisode = function(seriesIdx, episodeIdx, event) {
        event.stopPropagation();
        
        var dataJsCount = 0;
        if (typeof playerData !== 'undefined' && Array.isArray(playerData)) {
          dataJsCount = playerData.length;
        }
        
        if (seriesIdx < dataJsCount) {
          alert('无法删除来自data.js的剧集');
          return;
        }
        
        if (confirm('确定要删除这一集吗？')) {
          seriesData[seriesIdx].episodes.splice(episodeIdx, 1);
          
          if (seriesData[seriesIdx].episodes.length === 0) {
            seriesData.splice(seriesIdx, 1);
            saveSeriesData();
            renderSeriesList();
            
            if (seriesData.length > 0) {
              currentSeriesIndex = Math.min(currentSeriesIndex, seriesData.length - 1);
              displayEpisodes(currentSeriesIndex);
              playEpisode(currentSeriesIndex, 0);
            } else {
              showEmptyState();
            }
          } else {
            saveSeriesData();
            
            if (seriesIdx === currentSeriesIndex) {
              currentEpisodeIndex = Math.min(currentEpisodeIndex, seriesData[seriesIdx].episodes.length - 1);
              displayEpisodes(seriesIdx);
              playEpisode(seriesIdx, currentEpisodeIndex);
            }
          }
        }
      };

      window.switchTab = function(tabName) {
        console.log('切换到Tab:', tabName);
        
        var tabs = document.querySelectorAll('.sidebar-tab');
        var tabContents = document.querySelectorAll('.tab-content');
        
        for (var i = 0; i < tabs.length; i++) {
          if (tabs[i].getAttribute('data-tab') === tabName) {
            tabs[i].classList.add('active');
          } else {
            tabs[i].classList.remove('active');
          }
        }
        
        for (var j = 0; j < tabContents.length; j++) {
          tabContents[j].style.display = 'none';
        }
        
        var targetContent = document.getElementById(tabName + '-tab');
        if (targetContent) {
          targetContent.style.display = 'block';
        }
        
        if (tabName === 'history') {
          displayHistory();
        }
      };

      window.openAddVideoModal = function() {
        document.getElementById('add-video-overlay').style.display = 'flex';
        document.getElementById('series-title-input').focus();
      };

      window.closeAddVideoModal = function() {
        document.getElementById('add-video-overlay').style.display = 'none';
        document.getElementById('add-video-form').reset();
        var container = document.getElementById('episode-inputs-container');
        container.innerHTML =
          '<div class="episode-input-group">' +
            '<input type="text" placeholder="剧集名称 (如: 第1集)" required>' +
            '<input type="url" placeholder="视频地址 (http://... 或 https://...)" required>' +
            '<button type="button" class="remove-episode-btn" onclick="removeEpisodeInput(this)">-</button>' +
          '</div>';
      };

      window.openAddEpisodeModal = function() {
        document.getElementById('add-episode-overlay').style.display = 'flex';
        document.getElementById('episode-name-input').focus();
      };

      window.closeAddEpisodeModal = function() {
        document.getElementById('add-episode-overlay').style.display = 'none';
        document.getElementById('add-episode-form').reset();
      };

      window.addEpisodeInput = function() {
        var container = document.getElementById('episode-inputs-container');
        var newInputGroup = document.createElement('div');
        newInputGroup.className = 'episode-input-group';
        newInputGroup.innerHTML =
          '<input type="text" placeholder="剧集名称 (如: 第' + (container.children.length + 1) + '集)" required>' +
          '<input type="url" placeholder="视频地址 (http://... 或 https://...)" required>' +
          '<button type="button" class="remove-episode-btn" onclick="removeEpisodeInput(this)">-</button>';
        container.appendChild(newInputGroup);
      };

      window.removeEpisodeInput = function(button) {
        var container = document.getElementById('episode-inputs-container');
        if (container.children.length > 1) {
          button.parentElement.remove();
        }
      };

      // 初始化播放器
      function initializePlayer() {
        console.log('初始化播放器...');
        
        // 确保 playerData 已加载
        if (typeof playerData === 'undefined') {
          console.error('警告：playerData 未定义，尝试重新加载...');
          // 给一点时间让 data.js 加载
          setTimeout(function() {
            if (typeof playerData === 'undefined') {
              console.error('错误：无法加载 playerData');
              // 设置为空数组以避免错误
              window.playerData = [];
            }
            loadSeriesData();
            renderSeriesList();
          }, 100);
        } else {
          loadSeriesData();
          renderSeriesList();
        }
        
        // iOS检测
        var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        
        // 初始化Video.js播放器 - iOS 9优化配置
        var playerOptions = {
          html5: {
            hls: {
              overrideNative: false, // iOS 9 强制使用原生HLS
              withCredentials: false,
              enableLowInitialPlaylist: true,
              smoothQualityChange: false, // iOS 9 禁用平滑切换
              fastQualityChange: false // iOS 9 禁用快速切换
            },
            nativeVideoTracks: true, // iOS 9 使用原生轨道
            nativeAudioTracks: true,
            nativeTextTracks: true
          },
          techOrder: ['html5'],
          controls: true,
          preload: isIOS ? 'metadata' : 'auto', // iOS 9 优化：只预加载元数据
          fluid: true,
          responsive: true,
          errorDisplay: true,
          playsinline: true, // iOS 9 内联播放
          sources: []
        };
        
        try {
          player = videojs('my-video', playerOptions);
          console.log('Video.js播放器初始化成功');
          
          // 添加错误处理
          player.on('error', function() {
            var error = player.error();
            console.error('播放器错误:', error);
            if (error && error.code === 4) {
              // 媒体错误，可能是CORS或格式问题
              alert('视频加载失败，可能是网络问题或视频源不可用。\n错误信息：' + (error.message || '未知错误'));
            }
          });
          
          // 监听加载事件
          player.on('loadstart', function() {
            console.log('开始加载视频...');
          });
          
          player.on('loadeddata', function() {
            console.log('视频数据加载完成');
          });
          
          player.on('canplay', function() {
            console.log('视频可以播放');
          });
          
        } catch (e) {
          console.error('播放器初始化失败:', e);
          alert('播放器初始化失败，请刷新页面重试');
        }

        // 设置表单处理
        var addVideoForm = document.getElementById('add-video-form');
        if (addVideoForm) {
          addVideoForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            var title = document.getElementById('series-title-input').value.trim();
            if (!title) {
              alert('请输入系列标题');
              return;
            }
            
            var episodeInputs = document.querySelectorAll('#episode-inputs-container .episode-input-group');
            var episodes = [];
            
            for (var i = 0; i < episodeInputs.length; i++) {
              var inputs = episodeInputs[i].querySelectorAll('input');
              var name = inputs[0].value.trim();
              var url = inputs[1].value.trim();
              
              if (!name || !url) {
                alert('请完整填写第' + (i + 1) + '个剧集的信息');
                return;
              }
              
              if (url.indexOf('http://') !== 0 && url.indexOf('https://') !== 0) {
                alert('第' + (i + 1) + '个剧集的视频地址无效');
                return;
              }
              
              episodes.push({ name: name, url: url });
            }
            
            if (episodes.length === 0) {
              alert('请至少添加一个剧集');
              return;
            }
            
            var newSeriesIndex = seriesData.length;
            seriesData.push({ title: title, episodes: episodes });
            saveSeriesData();
            renderSeriesList();
            closeAddVideoModal();
            
            currentSeriesIndex = newSeriesIndex;
            currentEpisodeIndex = 0;
            displayEpisodes(newSeriesIndex);
            playEpisode(newSeriesIndex, 0);
            
            alert('视频系列添加成功！');
          });
        }

        var addEpisodeForm = document.getElementById('add-episode-form');
        if (addEpisodeForm) {
          addEpisodeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            var name = document.getElementById('episode-name-input').value.trim();
            var url = document.getElementById('episode-url-input').value.trim();
            
            if (!name || !url) {
              alert('请填写完整信息');
              return;
            }
            
            if (url.indexOf('http://') !== 0 && url.indexOf('https://') !== 0) {
              alert('请输入有效的视频地址');
              return;
            }
            
            var dataJsCount = 0;
            if (typeof playerData !== 'undefined' && Array.isArray(playerData)) {
              dataJsCount = playerData.length;
            }
            
            if (currentSeriesIndex < dataJsCount) {
              alert('无法向data.js中的系列添加剧集');
              return;
            }
            
            seriesData[currentSeriesIndex].episodes.push({ name: name, url: url });
            saveSeriesData();
            displayEpisodes(currentSeriesIndex);
            closeAddEpisodeModal();
            
            alert('剧集添加成功！');
          });
        }

        // 清除历史记录
        document.getElementById('clear-history').addEventListener('click', function() {
          if (confirm('确定要清除所有播放历史吗？')) {
            localStorage.removeItem('playHistory');
            displayHistory();
          }
        });

        // 初始化界面 - 移到上面了
        // renderSeriesList();
        
        // 延迟检查数据是否为空
        setTimeout(function() {
          if (seriesData.length === 0) {
            console.log('没有视频数据，显示空状态');
            showEmptyState();
            return;
          } else {
            console.log('找到', seriesData.length, '个视频系列');
            // 不自动播放第一个视频，等待用户选择
            updateActiveStates();
          }
        }, 200);

        // 检查保存的进度
        var savedProgressRaw = localStorage.getItem('playbackProgress');
        var shouldRestore = false;
        var savedProgress;

        if (savedProgressRaw) {
          try {
            savedProgress = JSON.parse(savedProgressRaw);
            if (savedProgress.seriesIndex < seriesData.length &&
                savedProgress.episodeIndex < seriesData[savedProgress.seriesIndex].episodes.length) {
              shouldRestore = true;
            }
          } catch (e) {
            localStorage.removeItem('playbackProgress');
          }
        }
        
        if (shouldRestore) {
          currentSeriesIndex = savedProgress.seriesIndex;
          currentEpisodeIndex = savedProgress.episodeIndex;
          displayEpisodes(currentSeriesIndex);
          setTimeout(function() {
            playEpisode(currentSeriesIndex, currentEpisodeIndex, savedProgress.time);
          }, 300);
        } else if (seriesData.length > 0) {
          // 只显示第一个系列的剧集列表，不自动播放
          displayEpisodes(0);
          updateActiveStates();
        }

        // 定期保存进度
        setInterval(saveProgress, 5000);
        
        player.on('pause', saveProgress);
        player.on('timeupdate', function() {
          // iOS 9 优化：减少保存频率，避免性能问题
          var currentTime = player.currentTime();
          if (isIOS && Math.floor(currentTime) % 15 === 0) {
            saveProgress();
          } else if (!isIOS && Math.floor(currentTime) % 10 === 0) {
            saveProgress();
          }
        });
        
        // 页面状态变化时保存进度
        document.addEventListener('visibilitychange', function() {
          if (document.hidden) saveProgress();
        });
        
        window.addEventListener('pagehide', saveProgress);
        window.addEventListener('beforeunload', saveProgress);

        // 视频播放结束，自动播放下一集
        player.on('ended', function() {
          var nextEpisodeIndex = currentEpisodeIndex + 1;
          var totalEpisodes = seriesData[currentSeriesIndex].episodes.length;
          if (nextEpisodeIndex < totalEpisodes) {
            playEpisode(currentSeriesIndex, nextEpisodeIndex);
          } else {
            localStorage.removeItem('playbackProgress');
          }
        });
      }

      // 密码验证
      document.addEventListener('DOMContentLoaded', function() {
        var passwordOverlay = document.getElementById('password-overlay');
        var passwordInput = document.getElementById('password-input');
        var passwordSubmit = document.getElementById('password-submit');
        var passwordError = document.getElementById('password-error');
        var mainContainer = document.querySelector('.container');
        
        var correctPassword = '666666';
        var AUTH_DURATION = 90 * 24 * 60 * 60 * 1000;
        var AUTH_KEY = 'videoPlayerAuth';

        function authenticate() {
          if (passwordInput.value === correctPassword) {
            var authData = {
              isAuthenticated: true,
              timestamp: Date.now(),
              expiry: Date.now() + AUTH_DURATION
            };
            localStorage.setItem(AUTH_KEY, JSON.stringify(authData));
            
            passwordOverlay.style.display = 'none';
            mainContainer.style.display = 'flex';
            initializePlayer();
            
            console.log('认证成功，有效期3个月');
          } else {
            passwordError.textContent = '密码错误，请重试！';
            passwordInput.value = '';
            passwordInput.focus();
          }
        }

        function checkAuthentication() {
          try {
            var authDataStr = localStorage.getItem(AUTH_KEY);
            if (!authDataStr) {
              return false;
            }
            
            var authData = JSON.parse(authDataStr);
            var now = Date.now();
            
            if (now > authData.expiry) {
              localStorage.removeItem(AUTH_KEY);
              console.log('认证已过期，需要重新输入密码');
              return false;
            }
            
            console.log('认证有效，剩余时间：', Math.round((authData.expiry - now) / (24 * 60 * 60 * 1000)), '天');
            return authData.isAuthenticated === true;
          } catch (e) {
            console.error('认证检查失败:', e);
            localStorage.removeItem(AUTH_KEY);
            return false;
          }
        }

        if (checkAuthentication()) {
          mainContainer.style.display = 'flex';
          initializePlayer();
        } else {
          passwordOverlay.style.display = 'flex';
          passwordInput.focus();
        }

        passwordSubmit.addEventListener('click', authenticate);
        passwordInput.addEventListener('keyup', function(event) {
          if (event.key === 'Enter' || event.keyCode === 13) {
            authenticate();
          }
        });
      });

    })();
  </script>
</body>
</html>
